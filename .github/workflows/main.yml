name: CI/CD Pipeline with UV & Ruff

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # ===== Job 1: Build =====
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install uv
        run: |
          curl -sSL https://ghcr.io/astral-sh/uv:latest | tar -xv -C /usr/local/bin uv uvx

      - name: Set working directory
        run: mkdir -p /app
      - name: Copy code (GitHub Actions workspace handles this automatically)
        run: echo "Code is already checked out"

      - name: Install dependencies with uv
        run: uv sync --frozen --no-cache

  # ===== Job 2: Lint =====
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install uv
        run: |
          curl -sSL https://ghcr.io/astral-sh/uv:latest | tar -xv -C /usr/local/bin uv uvx

      - name: Install dependencies
        run: uv sync --frozen --no-cache

      - name: Run lint with ruff
        run: uv run ruff check app/

  # ===== Job 3: Deploy =====
  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install uv
        run: |
          curl -sSL https://ghcr.io/astral-sh/uv:latest | tar -xv -C /usr/local/bin uv uvx

      - name: Install dependencies
        run: uv sync --frozen --no-cache

      - name: Deploy to production
        env:
          PROD_SERVER: ${{ secrets.PROD_SERVER }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_KEY: ${{ secrets.PROD_KEY }}
        run: |
          echo "Deploying to production server..."
          scp -i $PROD_KEY -r ./app $PROD_USER@$PROD_SERVER:/app
          ssh -i $PROD_KEY $PROD_USER@$PROD_SERVER "systemctl restart myapp.service"

      - name: Post-deploy verification (optional)
        run: curl -f https://myapp.example.com/health || exit 1
